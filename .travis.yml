sudo: required

notifications:
  slack: ska-sip:zgaO4jJWwB4UjFRulowC5g56

language: python

env:
  global:
    - SIP_PCI_LOG_LEVEL=NOTSET
    - SIP_PCI_LOG_LEVEL=WARN
    - SIP_DOCKER_API_LOG_LEVEL=INFO

services:
  - docker

python:
  - "3.6"

cache: pip

# https://github.com/travis-ci/travis-ci/issues/5358
before_install:
  # Add Docker repo to apt.
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  # Install API packages
  - sudo apt-get -qq update
  - sudo apt-get install -y gcc
  - sudo apt-get install -y g++
  - sudo apt-get install -y libboost-program-options-dev
  - sudo apt-get install -y libboost-system-dev
  - sudo apt-get install -y docker-ce
  # Install Python testing and linting dependencies
  - pip install codecov
  - pip install pylint>=1.9.0
  - pip install pycodestyle>=2.4.0
  - pip install pydocstyle>=2.1.1
  - pip install pytest>=3.5.1
  - pip install pytest-pylint>=0.9.0
  - pip install pytest-codestyle>=1.2.2
  - pip install pytest-docstyle>=1.3.2
  - pip install pytest-cov
  # Install dependencies for SIP packages
  - pip install spead2>=1.7.2
  - pip install -r sip/execution_control/processing_controller_interface/flask_api/requirements.txt
  - pip install -r sip/execution_control/configuration_db/redis/requirements.txt
  - pip install -r sip/execution_framework_interface/docker_api/requirements.txt
  - pip install -r sip/execution_framework_interface/docker_compose_generator/requirements.txt
  - pip install -r sip/science_pipeline_workflows/ical_dask/pipelines/requirements.arl.min.txt
  # Start Docker containers needed for unit tests
  - docker run -d -p 6379:6379 --name=config_db redis:4.0.6-alpine
  # Start Docker Swarm
  - docker swarm init

script:
  - pycodestyle --config=.pycodestyle emulators
  - pycodestyle --config=.pycodestyle --exclude=zookeeper examples
  - pycodestyle --config=.pycodestyle --exclude=receive_visibilities sip

  - pylint --rcfile=.pylintrc --ignore=csp_pss_sender,csp_vis_sender_01,csp_vis_sender_02 emulators

  - python -m pytest -s -v --codestyle --docstyle --pylint --pylint-rcfile=.pylintrc sip/execution_control/configuration_db
  - python -m pytest -s -v --codestyle --docstyle --pylint --pylint-rcfile=.pylintrc sip/execution_framework_interface/docker_api
  - python -m pytest -s -v --codestyle --docstyle --pylint --pylint-rcfile=.pylintrc sip/execution_framework_interface/docker_compose_generator
  - python -m pytest -s -v --codestyle --docstyle --pylint --pylint-rcfile=.pylintrc sip/science_pipeline_workflows/ical_dask

  - pytest --cov=sip/execution_control/configuration_db sip/execution_control/configuration_db

after_success:
  - codecov
